# Message Flow Diagrams

## System Overview

```
???????????????????????????????????????????????????????????????????
?                     Goldberg Master Server                       ?
???????????????????????????????????????????????????????????????????
?                                                                   ?
?  ????????????????    ??????????????????    ??????????????????  ?
?  ? UDP Listener ????>? MessageHandler ????>? Service Layer  ?  ?
?  ?  (26900)     ?    ?  (18 handlers) ?    ?  (Managers)    ?  ?
?  ????????????????    ??????????????????    ??????????????????  ?
?         ?                     ?                      ?           ?
?         ?                     ???> PeerManager       ?           ?
?         ?                     ???> LobbyManager      ?           ?
?         ?                     ???> GameserverManager ? (future)  ?
?         ?                     ???> FriendManager     ? (future)  ?
?         ?                     ???> StatsManager      ? (future)  ?
?         ?                     ???> P2PRelayManager   ? (future)  ?
?         ?                     ???> LeaderboardManager? (future)  ?
?         ?                                            ?           ?
?         v                                            v           ?
?  ????????????????????????????????????????????????????????????  ?
?  ?              NetworkService (UDP Send)                    ?  ?
?  ????????????????????????????????????????????????????????????  ?
?                              ?                                   ?
????????????????????????????????????????????????????????????????????
                               ?
                               v
                    ??????????????????????
                    ?  Goldberg Clients  ?
                    ??????????????????????
```

## Message Processing Flow

```
Client                    Network              Message               Service
 ?                        Service              Handler               Layer
 ?                          ?                    ?                     ?
 ???? UDP Packet ??????????>?                    ?                     ?
 ?                          ?                    ?                     ?
 ?                          ???? Buffer ???????>?                     ?
 ?                          ?   + EndPoint       ?                     ?
 ?                          ?                    ?                     ?
 ?                          ?                    ???? Parse ????????? ?
 ?                          ?                    ?   Protobuf       ? ?
 ?                          ?                    ?<?????????????????? ?
 ?                          ?                    ?                     ?
 ?                          ?                    ???? Route ????????>? ?
 ?                          ?                    ?   by Type          ? ?
 ?                          ?                    ?                     ?
 ?                          ?                    ?                     ?? Process
 ?                          ?                    ?                     ?
 ?                          ?                    ?                     ?? Update State
 ?                          ?                    ?                     ?
 ?                          ?<??? Response ???????<???????????????????
 ?                          ?   (if needed)      ?
 ?                          ?                    ?
 ?<??? UDP Packet ??????????                    ?
 ?                          ?                    ?
```

## Peer Discovery (PING/PONG)

```
Peer A                                Server                          Peer B
  ?                                     ?                               ?
  ?                                     ?                               ?
  ????? PING ?????????????????????????>?                               ?
  ?  {                                  ?                               ?
  ?    source_id: 123                   ?                               ?
  ?    announce: {                      ?                               ?
  ?      type: PING                     ?                               ?
  ?      appid: 480                     ???> PeerManager.AddOrUpdate    ?
  ?      tcp_port: 27015                ?    (123, 192.168.1.10, 480)  ?
  ?    }                                ?                               ?
  ?  }                                  ?                               ?
  ?                                     ?                               ?
  ?                                     ?<??? Previous PING ????????????
  ?                                     ?  {                            ?
  ?                                     ?    source_id: 456             ?
  ?                                     ?    appid: 480                 ?
  ?                                     ?  }                            ?
  ?                                     ?                               ?
  ?<???? PONG ??????????????????????????                               ?
  ?  {                                  ?                               ?
  ?    source_id: SERVER                ?                               ?
  ?    dest_id: 123                     ?                               ?
  ?    announce: {                      ?                               ?
  ?      type: PONG                     ?                               ?
  ?      appid: 480                     ?                               ?
  ?      peers: [                       ?                               ?
  ?        {                            ?                               ?
  ?          id: 456                    ?                               ?
  ?          ip: 192.168.1.11           ?                               ?
  ?          udp_port: 26900            ?                               ?
  ?          appid: 480                 ?                               ?
  ?        }                            ?                               ?
  ?      ]                              ?                               ?
  ?    }                                ?                               ?
  ?  }                                  ?                               ?
  ?                                     ?                               ?
  ????? Direct P2P ??????????????????????????????????????????????????>?
  ?  (Now knows Peer B exists)          ?                               ?
  ?                                     ?                               ?
```

## Lobby Creation & Join

```
Client A                          Server                        Client B
  ?                                 ?                              ?
  ????? Lobby ????????????????????>?                              ?
  ?  {                              ?                              ?
  ?    source_id: 123               ?                              ?
  ?    lobby: {                     ?                              ?
  ?      room_id: 999               ?                              ?
  ?      owner: 123                 ??> LobbyManager.Create        ?
  ?      appid: 480                 ?   (999, owner=123)           ?
  ?      member_limit: 4            ?                              ?
  ?      joinable: true             ?                              ?
  ?    }                            ?                              ?
  ?  }                              ?                              ?
  ?                                 ?                              ?
  ?<???? Lobby ?????????????????????                              ?
  ?  (confirmation)                 ?                              ?
  ?                                 ?                              ?
  ?                                 ?<???? Lobby_Messages ??????????
  ?                                 ?  {                           ?
  ?                                 ?    source_id: 456            ?
  ?                                 ?    lobby_messages: {         ?
  ?                                 ?      id: 999                 ?
  ?                                 ?      type: JOIN              ?
  ?                                 ?    }                         ?
  ?                                 ?  }                           ?
  ?                                 ?                              ?
  ?                                 ??> LobbyManager.Join          ?
  ?                                 ?   (999, member_id=456)       ?
  ?                                 ?                              ?
  ?<???? Lobby_Messages ?????????????                              ?
  ?  (JOIN broadcast)               ????? Lobby_Messages ????????>?
  ?                                 ?  (JOIN broadcast)            ?
  ?                                 ?                              ?
  ?<???? Lobby ??????????????????????                              ?
  ?  (updated member list)          ????? Lobby ?????????????????>?
  ?                                 ?  (full lobby state)          ?
  ?                                 ?                              ?
```

## Lobby Chat

```
Client A                          Server                        Client B, C, D
  ?                                 ?                              ?
  ????? Lobby_Messages ???????????>?                              ?
  ?  {                              ?                              ?
  ?    source_id: 123               ?                              ?
  ?    lobby_messages: {            ?                              ?
  ?      id: 999                    ??> LobbyManager.GetLobby      ?
  ?      type: CHAT_MESSAGE         ?   (999)                      ?
  ?      bdata: "Hello everyone!"   ?                              ?
  ?    }                            ??> GetOnlineMembers()         ?
  ?  }                              ?   [456, 789, 321]            ?
  ?                                 ?                              ?
  ?                                 ??> Broadcast (exclude 123)    ?
  ?                                 ?                              ?
  ?                                 ????? Lobby_Messages ????????>?
  ?                                 ?  {                           ?
  ?                                 ?    source_id: 123            ?
  ?                                 ?    dest_id: 456 (repeated)   ?
  ?                                 ?    lobby_messages: {         ?
  ?                                 ?      type: CHAT_MESSAGE      ?
  ?                                 ?      bdata: "Hello..."       ?
  ?                                 ?    }                         ?
  ?                                 ?  }                           ?
  ?                                 ?                              ?
```

## Gameserver Registration (Future)

```
Dedicated Server                 Server                          Clients
  ?                                 ?                              ?
  ????? Gameserver ???????????????>?                              ?
  ?  {                              ?                              ?
  ?    source_id: 789               ?                              ?
  ?    gameserver: {                ??> GameserverManager.Register ?
  ?      id: 789                    ?   (789, "My Server", ...)    ?
  ?      server_name: "My Server"   ?                              ?
  ?      map_name: "de_dust2"       ?                              ?
  ?      num_players: 5             ?                              ?
  ?      max_player_count: 16       ?                              ?
  ?      ip: 192.168.1.100          ?                              ?
  ?      port: 27015                ?                              ?
  ?      query_port: 27016          ?                              ?
  ?      appid: 730                 ?                              ?
  ?      secure: true               ?                              ?
  ?    }                            ?                              ?
  ?  }                              ?                              ?
  ?                                 ?                              ?
  ????? Gameserver ???????????????>?                              ?
  ?  (periodic updates)             ??> Update (players, map)      ?
  ?                                 ?                              ?
  ?                                 ?<???? Query ???????????????????
  ?                                 ?  (by appid, map, etc.)       ?
  ?                                 ?                              ?
  ?                                 ??> Filter servers             ?
  ?                                 ?   matching criteria          ?
  ?                                 ?                              ?
  ?                                 ????? Server List ???????????>?
  ?                                 ?  [                           ?
  ?                                 ?    {server1 details},        ?
  ?                                 ?    {server2 details},        ?
  ?                                 ?    ...                       ?
  ?                                 ?  ]                           ?
  ?                                 ?                              ?
```

## P2P Relay (Future)

```
Client A                          Server                        Client B
  ?                                 ?                              ?
  ????? Networking_Sockets ???????>?                              ?
  ?  {                              ?                              ?
  ?    source_id: 123               ?                              ?
  ?    dest_id: 456                 ??> P2PRelayManager           ?
  ?    networking_sockets: {        ?   .FindConnection(123?456)   ?
  ?      type: DATA                 ?                              ?
  ?      connection_id: 1001        ??> RoutePacket               ?
  ?      data: [encrypted bytes]    ?                              ?
  ?      message_number: 42         ?                              ?
  ?    }                            ?                              ?
  ?  }                              ?                              ?
  ?                                 ?                              ?
  ?                                 ????? Networking_Sockets ????>?
  ?                                 ?  {                           ?
  ?                                 ?    source_id: 123            ?
  ?                                 ?    dest_id: 456              ?
  ?                                 ?    networking_sockets: {     ?
  ?                                 ?      type: DATA              ?
  ?                                 ?      data: [bytes]           ?
  ?                                 ?      message_number: 42      ?
  ?                                 ?    }                         ?
  ?                                 ?  }                           ?
  ?                                 ?                              ?
  ?                                 ?<???? Networking_Sockets ??????
  ?                                 ?  (response)                  ?
  ?                                 ?                              ?
  ?<???? Networking_Sockets ????????                              ?
  ?  (relayed response)             ?                              ?
  ?                                 ?                              ?
```

## Stats Synchronization (Future)

```
Game Client                       Server                      Game Server
  ?                                 ?                              ?
  ?                                 ?<???? GameServerStats ?????????
  ?                                 ?  {                           ?
  ?                                 ?    type: Request_AllUserStats?
  ?                                 ?    initial_user_stats: {     ?
  ?                                 ?      steam_api_call: 5001    ?
  ?                                 ?    }                         ?
  ?                                 ?  }                           ?
  ?                                 ?                              ?
  ?<???? GameServerStats ???????????                              ?
  ?  (forwarded request)            ?                              ?
  ?                                 ?                              ?
  ????? GameServerStats ??????????>?                              ?
  ?  {                              ?                              ?
  ?    type: Response_AllUserStats  ??> StatsManager.Store         ?
  ?    initial_user_stats: {        ?   (user_id, stats, achs)     ?
  ?      steam_api_call: 5001       ?                              ?
  ?      all_data: {                ?                              ?
  ?        user_stats: {...}        ?                              ?
  ?        user_achievements: {...} ?                              ?
  ?      }                          ?                              ?
  ?    }                            ?                              ?
  ?  }                              ?                              ?
  ?                                 ?                              ?
  ?                                 ????? GameServerStats ???????>?
  ?                                 ?  (forwarded response)        ?
  ?                                 ?                              ?
```

## Leaderboard Update (Future)

```
Client                            Server                        Other Clients
  ?                                 ?                              ?
  ????? Leaderboards_Messages ????>?                              ?
  ?  {                              ?                              ?
  ?    source_id: 123               ?                              ?
  ?    leaderboards_messages: {     ??> LeaderboardManager         ?
  ?      type: UpdateUserScore      ?   .UpdateScore(...)          ?
  ?      appid: 480                 ?                              ?
  ?      leaderboard_info: {        ??> Recalculate ranks          ?
  ?        board_name: "Speedrun"   ?                              ?
  ?        sort_method: ASC         ?                              ?
  ?        display_type: TIME       ?                              ?
  ?      }                          ?                              ?
  ?      user_score_entry: {        ?                              ?
  ?        score: 125000            ?                              ?
  ?        score_details: [...]     ?                              ?
  ?      }                          ?                              ?
  ?    }                            ?                              ?
  ?  }                              ?                              ?
  ?                                 ?                              ?
  ?<???? Leaderboards_Messages ?????                              ?
  ?  (confirmation + rank)          ?                              ?
  ?                                 ?                              ?
  ?                                 ????? Leaderboards_Messages ??>?
  ?                                 ?  (notify friends of new      ?
  ?                                 ?   high score)                ?
  ?                                 ?                              ?
```

## Message Type Routing

```
??????????????????????????????????????????????????????????????????
?                      MessageHandler.HandleMessageAsync         ?
??????????????????????????????????????????????????????????????????
?                                                                  ?
?  Parse(buffer) ??????> Common_Message                          ?
?                             ?                                    ?
?                             ?                                    ?
?              ????????????????????????????????                  ?
?              ?   switch(message.MessagesCase)?                  ?
?              ????????????????????????????????                  ?
?                             ?                                    ?
?       ?????????????????????????????????????????????            ?
?       ?                     ?                     ?            ?
?       v                     v                     v            ?
?   Announce              Lobby              Gameserver          ?
?   ??> PING/PONG         ??> Create         ??> Register       ?
?   ??> HandlePing()      ??> Update         ??> HandleGameserver()?
?                         ??> Query                              ?
?                         ??> HandleLobby()                      ?
?                                                                  ?
?       ?                     ?                     ?            ?
?       v                     v                     v            ?
?   Low_Level           Lobby_Messages          Friend           ?
?   ??> HEARTBEAT        ??> JOIN              ??> Update        ?
?   ??> CONNECT          ??> LEAVE             ??> HandleFriend()?
?   ??> DISCONNECT       ??> CHAT                               ?
?   ??> HandleLowLevel() ??> HandleLobbyMsg()                   ?
?                                                                  ?
?       ?                     ?                     ?            ?
?       v                     v                     v            ?
?   Network_pb          Auth_Ticket          Friend_Messages     ?
?   ??> DATA             ??> CANCEL           ??> LOBBY_INVITE   ?
?   ??> HandleNetworkPb()??> HandleAuthTkt()  ??> GAME_INVITE   ?
?                                              ??> HandleFriendMsg()?
?                                                                  ?
?       ?                     ?                     ?            ?
?       v                     v                     v            ?
?   Networking_*        Steam_Messages         Stats_Messages    ?
?   ??> Sockets          ??> FRIEND_CHAT      ??> GameServer    ?
?   ??> Messages         ??> HandleSteamMsg() ??> Leaderboards  ?
?   ??> Old                                    ??> User_Stats    ?
?                                                                  ?
????????????????????????????????????????????????????????????????????
```

## Data Flow: Complete Message Lifecycle

```
1. UDP Packet Arrives
        ?
        v
2. NetworkService.ReceiveAsync()
   ??> Read buffer and endpoint
   ??> Return to MasterServer
        ?
        v
3. MasterServer.StartListeningAsync()
   ??> Spawn async task
   ??> Call MessageHandler
        ?
        v
4. MessageHandler.HandleMessageAsync()
   ??> Parse protobuf
   ??> Log message type
   ??> Route to specific handler
   ??> Invoke handler method
        ?
        v
5. Specific Handler (e.g., HandleLobbyAsync)
   ??> Validate sender
   ??> Get peer from PeerManager
   ??> Process business logic
   ??> Call manager service
        ?
        v
6. Manager Service (e.g., LobbyManager)
   ??> Update in-memory state
   ??> Perform validations
   ??> Calculate changes
   ??> Return result
        ?
        v
7. Handler (continued)
   ??> Determine recipients
   ??> Create response message(s)
   ??> Call NetworkService
        ?
        v
8. NetworkService.SendAsync() / BroadcastAsync()
   ??> Serialize to protobuf
   ??> Send UDP packet(s)
   ??> Log transmission
        ?
        v
9. Packet(s) sent to client(s)
```

## Error Handling Flow

```
??????????????????????????????????????????????
?         Error at any stage                 ?
??????????????????????????????????????????????
                 ?
                 v
         ?????????????????
         ? Catch block   ?
         ?????????????????
                 ?
     ?????????????????????????
     ?                       ?
     v                       v
InvalidProtocolBufferException   General Exception
     ?                       ?
     ??> Log Warning         ??> Log Error
     ?   "Invalid proto"     ?   "Error processing"
     ?                       ?
     ??> Continue            ??> Continue
         (drop packet)           (drop packet)
```

## Cleanup & Maintenance

```
Timer (10s)                           Timer (Background)
    ?                                      ?
    v                                      v
PeerManager.CleanupStaleMembers    LobbyManager.CleanupLoop
    ?                                      ?
    ??> For each peer                      ??> For each lobby
    ?   ??> Check LastSeen                 ?   ??> Check deleted flag
    ?   ??> If > 30s timeout               ?   ??> Check last update
    ?   ?   ??> Remove peer                ?   ??> If deleted + 5min
    ?   ?   ??> Log disconnect             ?   ?   ??> Remove lobby
    ?   ??> Continue                       ?   ??> Continue
    ?                                      ?
    ??> Log cleanup count                  ??> Run continuously
```

---

## Legend

```
??>   Data flow / Message
?     Sequential operation
??>   Branch / Option
??>   End of branch
v     Flow direction
[...]  Data/Array
{...}  Object/Structure
```

## Notes

- All messages are UDP-based for low latency
- Server uses async/await for non-blocking I/O
- Cleanup happens automatically via timers
- All operations are logged for debugging
- Error handling prevents one bad message from crashing server
