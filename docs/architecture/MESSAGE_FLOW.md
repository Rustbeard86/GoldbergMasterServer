# Message Flow Diagrams

This document provides visual representations of how messages flow through the Goldberg Master Server.

---

## System Architecture

```
???????????????????????????????????????????????????????
?           Goldberg Master Server                     ?
???????????????????????????????????????????????????????
?                                                       ?
?  ????????????    ???????????????    ?????????????? ?
?  ?   UDP    ????>?  Message    ????>?  Service   ? ?
?  ? Listener ?    ?  Handler    ?    ?  Managers  ? ?
?  ? (26900)  ?    ?(18 handlers)?    ?            ? ?
?  ????????????    ???????????????    ?????????????? ?
?       ?                 ?                    ?       ?
?       ?                 ???> PeerManager     ?       ?
?       ?                 ???> LobbyManager    ?       ?
?       ?                 ???> GameserverMgr   ?       ?
?       ?                 ???> P2PRelayManager ?       ?
?       ?                                      ?       ?
?       v                                      v       ?
?  ?????????????????????????????????????????????????  ?
?  ?      NetworkService (UDP Send)                ?  ?
?  ?????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????
                       ?
                       v
               ?????????????????
               ?  Game Clients ?
               ?????????????????
```

---

## Message Processing Flow

```
Client          NetworkService     MessageHandler      ServiceLayer
  ?                   ?                   ?                 ?
  ?? UDP Packet ?????>?                   ?                 ?
  ?                   ?? Buffer +         ?                 ?
  ?                   ?  EndPoint         ?                 ?
  ?                   ?                   ?                 ?
  ?                   ?                   ?? Parse Protobuf ?
  ?                   ?                   ?                 ?
  ?                   ?                   ?? Route by Type?>?
  ?                   ?                   ?                 ?
  ?                   ?                   ?                 ?? Process
  ?                   ?                   ?                 ?? Update
  ?                   ?                   ?<?? Response ?????
  ?                   ?<?? UDP Response ???                 ?
  ?<? UDP Packet ??????                   ?                 ?
```

---

## Peer Discovery (PING/PONG)

```
Peer A                    Server                    Peer B
  ?                          ?                         ?
  ?? PING ???????????????????>?                         ?
  ?  {source: 123,           ?                         ?
  ?   appid: 480}            ??> PeerManager           ?
  ?                          ?   .AddOrUpdate(123)     ?
  ?                          ?                         ?
  ?                          ?<? PING from B ???????????
  ?<? PONG ????????????????????                         ?
  ?  {peers: [456]}          ?                         ?
  ?                          ?                         ?
  ?? Direct P2P ??????????????????????????????????????>?
  ?  (Now knows B exists)    ?                         ?
```

---

## Lobby Creation & Join

```
Client A              Server              Client B
  ?                     ?                    ?
  ?? CreateLobby ???????>?                    ?
  ?  {room: 999,        ??> LobbyManager     ?
  ?   owner: 123}       ?   .Create(999)     ?
  ?                     ?                    ?
  ?<? Confirmation ???????                    ?
  ?                     ?                    ?
  ?                     ?<? JOIN ??????????????
  ?                     ??> .Join(999, 456)  ?
  ?                     ?                    ?
  ?<? Member Joined ??????? Member Joined ???>?
  ?   (broadcast)       ?   (broadcast)      ?
```

---

## Lobby Chat Broadcast

```
Client A              Server              Clients B,C,D
  ?                     ?                    ?
  ?? CHAT_MESSAGE ??????>?                    ?
  ?  "Hello everyone!"  ??> GetOnlineMembers ?
  ?                     ?   [B, C, D]        ?
  ?                     ?                    ?
  ?                     ?? Broadcast ????????>?
  ?                     ?  (exclude sender)  ?
  ?                     ?                    ?
```

---

## Game Server Registration

```
Dedicated Server       Server              Clients
  ?                     ?                    ?
  ?? Gameserver ????????>?                    ?
  ?  {name, map,        ??> GameserverMgr   ?
  ?   players, ...}     ?   .Register()     ?
  ?                     ?                    ?
  ?? Updates ???????????>?                    ?
  ?  (periodic)         ??> .Update()       ?
  ?                     ?                    ?
  ?                     ?<? Query ?????????????
  ?                     ??> Filter servers   ?
  ?                     ?                    ?
  ?                     ?? Server List ??????>?
```

---

## P2P Relay (Data Flow)

```
Client A              Server              Client B
  ?                     ?                    ?
  ?? DATA ??????????????>?                    ?
  ?  {dest: B,          ??> P2PRelayManager  ?
  ?   connectionId: 1}  ?   .RoutePacket()   ?
  ?                     ?                    ?
  ?                     ?? Forward DATA ?????>?
  ?                     ?                    ?
  ?                     ?<? DATA ??????????????
  ?<? Forward DATA ???????                    ?
```

---

## Message Routing

```
MessageHandler.HandleMessageAsync()
                ?
       ?????????????????????
       v                    v
  ???????????        ????????????
  ? Announce?        ?  Lobby   ?
  ? (PING)  ?        ? (CRUD)   ?
  ???????????        ????????????
       v                    v
  HandlePing()       HandleLobby()
       ?                    ?
       ??> PeerManager      ??> LobbyManager
       
       v                    v
  ????????????       ???????????????
  ? Low_Level?       ?Lobby_Messages?
  ?(HEARTBEAT)?      ?  (JOIN/CHAT) ?
  ????????????       ???????????????
       v                    v
  HandleLowLevel()  HandleLobbyMessages()
       ?                    ?
       ??> Update           ??> Broadcast
       ?   LastSeen         ?   to members
```

---

## Complete Message Lifecycle

```
1. UDP Packet Arrives
        ?
2. NetworkService.ReceiveAsync()
   ? Read buffer and endpoint
        ?
3. MessageHandler.HandleMessageAsync()
   ? Parse protobuf
   ? Route to handler
        ?
4. Specific Handler (e.g., HandleLobbyAsync)
   ? Validate sender
   ? Process business logic
   ? Call manager service
        ?
5. Manager Service (e.g., LobbyManager)
   ? Update state
   ? Validate changes
   ? Return result
        ?
6. Handler creates response
        ?
7. NetworkService.SendAsync()
   ? Serialize protobuf
   ? Send UDP packet(s)
```

---

## Cleanup & Maintenance

```
Timer (10 seconds)
        ?
        ??> PeerManager.CleanupStaleMembers()
        ?   ? Remove peers not seen > 30s
        ?
        ??> LobbyManager.CleanupStaleLobbies()
        ?   ? Remove lobbies inactive > 5min
        ?
        ??> GameserverManager.CleanupStaleServers()
        ?   ? Mark servers offline > 5min
        ?
        ??> P2PRelayManager.CleanupStaleConnections()
            ? Close connections idle > 5min
```

---

## Error Handling Flow

```
?????????????????????????
? Error at any stage    ?
?????????????????????????
            ?
            v
     ????????????????
     ? Catch block  ?
     ????????????????
            ?
    ??????????????????
    v                v
Invalid Proto    General Error
    ?                ?
    ??> Log Warning  ??> Log Error
    ?   "Invalid     ?   "Processing
    ?    proto"      ?    failed"
    ?                ?
    ??> Drop packet  ??> Drop packet
```

---

## Legend

- `???>` Data flow / Message
- `?` Sequential operation  
- `v` Flow direction
- `[...]` Array/List
- `{...}` Object/Structure

---

## See Also

- [System Architecture](SYSTEM_ARCHITECTURE.md)
- [Implementation Summary](../IMPLEMENTATION_SUMMARY.md)
- [Feature Documentation](../features/)
